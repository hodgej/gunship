define(["require","exports","tslib","react","lodash","metaserver/static/js/modules/constants/page_load","metaserver/static/js/campaigns/emitter","metaserver/static/js/campaigns/api","metaserver/static/js/core/exception","metaserver/static/js/onboarding/logging/events","metaserver/static/js/campaigns/fullscreen_formats","metaserver/static/js/campaigns/utils/logging","metaserver/static/js/campaigns/types","metaserver/static/js/campaigns/history_utils","metaserver/static/js/campaigns/utils/pap_logging","metaserver/static/js/upsell/prompt_event_emitter","metaserver/static/js/campaigns/campaign_enums"],(function(e,a,t,n,i,s,o,c,r,p,g,m,l,_,u,d,E){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.CampaignsToolkit=a.fetchCampaigns=void 0,n=t.__importStar(n),s=t.__importStar(s),c=t.__importStar(c),r=t.__importStar(r);a.fetchCampaigns=(e={},a,n)=>t.__awaiter(void 0,void 0,void 0,(function*(){try{const t=[],{campaigns_result:i,campaigns_to_slots:o}=yield c.getBestCampaignsForUser({campaign_properties:e,event_context:{file_extension:(null==a?void 0:a.file_extension)&&a.file_extension,file_name:(null==a?void 0:a.file_name)&&a.file_name,upload_error_type:(null==a?void 0:a.upload_error_type)&&a.upload_error_type,file_path:(null==a?void 0:a.file_path)&&a.file_path,file_extensions_in_directory:(null==a?void 0:a.file_extensions_in_directory)&&a.file_extensions_in_directory},locale:s.USER_LOCALE,load_method:n});return null==i||i.campaigns.forEach(e=>{var a,n;t.push({campaign:e,requestId:null==i?void 0:i.request_id,slotId:null!==(a=null==o?void 0:o[e.version_id])&&void 0!==a?a:{".tag":"other"},currentSequenceStep:null===(n=e.sequence)||void 0===n?void 0:n.root})}),t}catch(a){r.reportException({err:a,tags:["fetchCampaigns","campaigns"],severity:r.SEVERITY.NONCRITICAL,exc_extra:{args:e}})}return[]}));const v=e=>{const a={};return e.forEach(e=>{e.currentSequenceStep&&(a[e.campaign.campaign_id]=e.currentSequenceStep)}),a},f=[l.CampaignEvents.DOWNLOAD_BUTTON_CLICKED,l.CampaignEvents.FILE_SHARE_SUCCESS,l.CampaignEvents.FILE_UPLOAD_FAILURE,l.CampaignEvents.SHARE_MODAL_CLOSED,l.CampaignEvents.PAGE_LOAD,l.CampaignEvents.FILE_UPLOAD_SUCCESS,l.CampaignEvents.DELETE_SUCCESS];a.CampaignsToolkit=({emitter:e=o.campaignsEmitter,loadMethod:s})=>{const[{campaigns:c,page:r,context:l,sequenceMap:C,hasLegacyPromptConflict:S,selectiveCampaign:A},O]=(0,n.useState)({campaigns:[],page:"",context:void 0,sequenceMap:{},hasLegacyPromptConflict:void 0,selectiveCampaign:void 0});return(0,n.useEffect)(()=>{const a=({data:{page:e,context:a}})=>{var t;const n=null!==(t=new URL(window.location.href).searchParams.get("_spec_campaign"))&&void 0!==t?t:void 0;O(t=>Object.assign(Object.assign({},t),{page:e,context:a,selectiveCampaign:n})),(0,_.resetHistoryForEvent)(o.PAGE_LOADED),(0,u.setPageName)(e)};return e.on(o.PAGE_LOADED,a),()=>{e.off(o.PAGE_LOADED,a)}},[]),(0,n.useEffect)(()=>{const a=()=>{(0,_.resetHistoryForEvent)(o.PAGE_CHANGED),O(e=>(e.campaigns.forEach(e=>{(0,o.clearCampaignInSlot)(e)}),Object.assign(Object.assign({},e),{campaigns:[],page:""})))};return e.on(o.PAGE_CHANGED,a),()=>{e.off(o.PAGE_CHANGED,a)}},[]),(0,n.useEffect)(()=>{d.promptBufferedEventEmitter.on(d.Events.ON_PROMPT_INITIALIZED,e=>t.__awaiter(void 0,void 0,void 0,(function*(){const a=e&&(e.didMainCampaignLoad()||e.didTopNotificationLoad());O(e=>Object.assign(Object.assign({},e),{hasLegacyPromptConflict:a}))})))},[]),(0,n.useEffect)(()=>{const a=e=>{const a=c.filter(a=>{var t;const n=null===(t=null==a?void 0:a.campaign)||void 0===t?void 0:t.campaign_id;return!!n&&String(n)!==e}),t=(0,i.cloneDeep)(C);delete t[parseInt(e,10)],O(e=>Object.assign(Object.assign({},e),{campaigns:a,sequenceMap:t}))};return e.on(o.CAMPAIGN_DISMISSED,a),()=>{e.off(o.CAMPAIGN_DISMISSED,a)}},[c]),(0,n.useEffect)(()=>{const a=({campaignId:e,ctaId:a})=>{var t,n,s;const r=parseInt(e,10),g=c.find(e=>e.campaign.campaign_id===r),l=null==g?void 0:g.currentSequenceStep,_=null!==(n=null===(t=null==g?void 0:g.campaign.sequence)||void 0===t?void 0:t.nodes)&&void 0!==n?n:{},u={campaign:{campaign_id:r,version_id:-1,prompt_queried_at_ms:-1,campaign_name:"campaignWithOnlyCampaignId"},requestId:"",slotId:{".tag":"other"}};if(!(g&&l&&a&&l in _))return void(0,m.logCampaignSequenceEvent)(p.CampaignsToolkitSequenceEvents.MISSING_OR_INVALID_PARAMETERS,null!=g?g:u,l,a);const d=null===(s=_[l].children)||void 0===s?void 0:s[a];if(!d)return(0,m.logCampaignSequenceEvent)(p.CampaignsToolkitSequenceEvents.SEQUENCE_COMPLETED,g,l,a),void(0,o.emitCampaignDismissed)(e);const E=Object.assign(Object.assign({},g),{currentSequenceStep:d}),v=c.map(e=>e.campaign.campaign_id===r?E:e),f=(0,i.cloneDeep)(C);f[r]=d,O(e=>Object.assign(Object.assign({},e),{campaigns:v,sequenceMap:f})),(0,m.logCampaignSequenceEvent)(p.CampaignsToolkitSequenceEvents.PROGRESS_SEQUENCE,g,d,a),(0,o.emitCampaignToSlot)(E)};return e.on(o.CAMPAIGN_SEQUENCE_ACTION,a),()=>{e.off(o.CAMPAIGN_SEQUENCE_ACTION,a)}},[c,C]),(0,n.useEffect)(()=>{const n=({name:e,data:{context:n,loggingParams:c}={}})=>t.__awaiter(void 0,void 0,void 0,(function*(){if(!f.includes(e))return;const t=yield(0,a.fetchCampaigns)({page:r,action:e},n,s),p=v(t);O(e=>Object.assign(Object.assign({},e),{campaigns:(0,i.uniqBy)([...e.campaigns,...t].reverse(),o.getSlotFromCampaignFormatProps),sequenceMap:Object.assign(Object.assign({},e.sequenceMap),p)})),t.forEach(e=>{(0,o.emitCampaignToSlot)(e,n,c)})}));return e.on(o.CAMPAIGN_EVENT,n),()=>{e.off(o.CAMPAIGN_EVENT,n)}},[r]),(0,n.useEffect)(()=>{const e=()=>t.__awaiter(void 0,void 0,void 0,(function*(){const e=yield(0,a.fetchCampaigns)({page:r,selective_campaign:A||void 0},l,s),t=v(e);O(a=>Object.assign(Object.assign({},(0,i.omit)(a,"context")),{campaigns:e,sequenceMap:t,selectiveCampaign:void 0})),e.forEach(e=>(0,o.emitCampaignToSlot)(e,l))}));r&&((e=>E.CampaignPageName.BROWSE===e)(r)?!1===S&&e():e())},[r,S]),n.default.createElement(g.FullscreenFormats,null)}}));
//# sourceMappingURL=campaigns_toolkit_client.min.js-vfl2DVJFC.map