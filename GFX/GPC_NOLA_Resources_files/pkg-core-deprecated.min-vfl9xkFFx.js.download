define("metaserver/static/js/deprecated_ajax/ajax_jquery",["require","exports","tslib","@dropbox/ttvc","metaserver/static/js/deprecated_ajax/job_progress","metaserver/static/js/deprecated_ajax/util","metaserver/static/js/core/persistence/storage","metaserver/static/js/modules/constants/ajax_strings","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/core/assert","metaserver/static/js/core/browser","metaserver/static/js/core/html","metaserver/static/js/core/notify","metaserver/static/js/core/uri","metaserver/static/js/clean/csrf","metaserver/static/js/clean/viewer"],(function(e,t,s,r,n,o,i,a,c,d,u,l,h,_,p,m,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SilentBackgroundBeaconRequest=t.ValidationSchemaRequest=t.SilentBackgroundRequest=t.BackgroundRequest=t.WebProgressRequest=t.FormWebRequest=t.WebRequestOref=t.WebRequest=t.Request=t.RESPONSE_PREFIX_NOTIFY_ERROR=t.getFakeJQXHR=void 0,n=s.__importStar(n),i=s.__importStar(i),a=s.__importStar(a),c=s.__importStar(c),d=s.__importStar(d),l=s.__importStar(l);function g(e){return e}t.getFakeJQXHR=e=>({response:void 0,responseText:"",status:0,statusText:"",getResponseHeader:function(e){return this.response?this.response.headers.get(e):null},readyState:XMLHttpRequest.UNSENT,abortController:e,thens:[],catches:[],abort:()=>e&&e.abort(),then:function(e,t){return this.thens.push(e),this.catches.push(t),this},catch:function(e){return this.catches.push(e),this},resolve:function(e){this.thens.forEach(t=>{t&&t(e)})},reject:function(e){this.catches.forEach(t=>{t&&t(e)})}});t.RESPONSE_PREFIX_NOTIFY_ERROR="err:";function b(e,s){var n;null==e&&(e={}),null==s&&(s=[]);const i=new v(e),a=w(i,s),c=a.options().type||"POST",d=a.data(),u=a.dataType(),l=a.headers();l.has("Content-Type")||l.append("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");let h=String(a.url());const _=new AbortController,p={method:c,mode:"cors",credentials:e.credentials||"include",headers:l,signal:_.signal};if("POST"===c){const e=null===(n=l.get("Content-Type"))||void 0===n?void 0:n.includes("application/x-www-form-urlencoded");p.body=e?(0,o.jqParam)(d,!0):d}else h=(0,o.mergeQueryParams)(h,d);const m=(0,t.getFakeJQXHR)(_);(0,r.incrementAjaxCount)();const f=fetch(h,p).then(e=>e.text().then(t=>({response:e,responseText:t}))).then(({response:e,responseText:s})=>{const{ok:r,status:n,statusText:o}=e;if(m.response=e,m.readyState=XMLHttpRequest.DONE,m.responseText=s,m.status=n,m.statusText=o,r)if("abort"===o)a.error(m,"aborted","abort"),a.complete(m,"aborted");else if("failed"===o)a.error(m,"failed",o),a.complete(m,"failed");else if("json"===u)try{const e=s.startsWith(t.RESPONSE_PREFIX_NOTIFY_ERROR)?s:JSON.parse(s);a.success(e,"success",m),a.complete(m,"success"),m.resolve(e)}catch(e){a.error(m,"parsererror",e.message),a.complete(m,"parsererror")}else a.success(s,"success",m),a.complete(m,"success"),m.resolve(s);else{m.status=e.status;const t=500===e.status?"":s;m.responseText=t,a.error(m,"error",t||m.statusText),a.complete(m,"error"),m.reject(m.responseText)}return e}).catch(e=>{"AbortError"===e.name?(m.statusText="abort",a.error(m,"aborted","abort"),a.complete(m,"aborted")):(a.error(m,"error",e.message),a.complete(m,"error")),m.reject(e)}).finally(r.decrementAjaxCount);return a.request(f),m}function x(e){return e.type===y.CHAINED}t.Request=b;const w=function(e,t){const s=[e];for(const e of Array.from(t.slice(0).reverse()))s.push(new e);let r=e;for(const e of s)r&&x(e)&&(e.next=r),r=e;return r};var y;(function(e){e.BASE="base",e.CHAINED="chained"})(y||(y={}));class v{constructor(e){this.type=y.BASE;const t=e||{},s=new Headers,r=t.headers||{};Object.keys(r).forEach(e=>{const t=r[e]||"";s.append(e,String(t))}),this.options=()=>t,this.url=()=>String(t.url||""),this.data=()=>t.data||{},this.dataType=()=>t.dataType||"text",this.headers=()=>s,this.success=t.success||g,this.error=t.error||g,this.complete=t.complete||g,this.request=g}}class j{constructor(){this.type=y.CHAINED}options(){return this.next.options()}url(){return this.next.url()}contentType(){return this.next.contentType()}data(){return this.next.data()}dataType(){return this.next.dataType()}headers(){return this.next.headers()}success(e,t,s){this.next.success(e,t,s)}error(e,t,s){this.next.error(e,t,s)}complete(e,t){this.next.complete(e,t)}request(e){this.next.request(e)}}class E extends j{constructor(){super(...arguments),this.SUPPORTED_TLDS=["dropbox.com"]}static initClass(){}data(){if(this.options().skipInjectCsrf)return this.next.data();(0,u.assert)(this._is_db_domain(),"injecting CSRF token into request to non-dropbox domain");const e={is_xhr:!0};return"GET"!==(this.options().type||"POST").toUpperCase()&&(e.t=(0,m.readCsrfToken)()),Object.assign(Object.assign({},e),this.next.data())}_is_db_domain(){const e=p.URI.parse(String(this.url())).getAuthority();if(!e)return!0;const t=e.split(".");return this.SUPPORTED_TLDS.reduce((function(e,s){const r=s.split("."),n=t.slice(-1*r.length).join(".");return e||s===n}),!1)}}E.initClass();class R extends j{data(){const e=this.next.data(),t=this.options();return t.subject_user&&!e._subject_uid&&(e._subject_uid=String(t.subject_user)),e}headers(){const e=this.next.headers(),t=this.options();return t.subject_user&&e.set("X-DROPBOX-UID",String(t.subject_user)),e}}class S extends j{headers(){var e,t;const s=this.next.headers(),r=this.options().teamAuthParams||{},n=r.team_id||f.Viewer.get_viewer().team_id;if(n){const{subject_user:r}=this.options(),o=null===(e=this.next.data())||void 0===e?void 0:e._subject_uid,i=("number"==typeof r?r:null==r?void 0:r.id)||("string"==typeof o?parseInt(o,10):o);i&&i===(null===(t=f.Viewer.get_viewer().work_user)||void 0===t?void 0:t.id)&&s.set("X-Dropbox-Teamid",String(n))}const o=r.auth_role||f.Viewer.get_viewer().auth_role,i=r.auth_action_type||f.Viewer.get_viewer().auth_action_type;return(o||i)&&s.set("X-Dropbox-Team-Authorization",JSON.stringify({auth_role:String(o),auth_action_type:String(i)})),s}}class O extends j{data(){const e=this.next.data();return d.REQUEST_TRACING_ENABLED?Object.assign({parent_request_id:d.REQUEST_ID},e):e}headers(){const e=this.next.headers(),t=this.options().type||"POST";return d.REQUEST_TRACING_ENABLED&&"POST"===t.toUpperCase()&&e.append("x-dropbox-force-request-tracing","ON"),e}}class T extends j{success(e,s,r){let n;if(!r.responseText.length)return this.next.error(r,s,"AJAX Response was empty.");const o=this.options();let i=!0,a=!1;if(0===r.responseText.indexOf(t.RESPONSE_PREFIX_NOTIFY_ERROR))n=r.responseText.substr(t.RESPONSE_PREFIX_NOTIFY_ERROR.length),["{","["].includes(n[0])&&(i=!1);else{if(0!==r.responseText.indexOf("htmlerr:"))return this.next.success(e,s,r);n=r.responseText.substr("htmlerr:".length),a=!0}const c=this.next.error(r,s,n);if(i&&!o.skipNotifyError){let e=n;a&&(e=new h.HTML(n)),_.Notify.error(e)}return c}error(e,t,s){const r=this.options();return"aborted"===t||r.skipNotifyError||_.Notify.error(a.PROBLEM_COMPLETING_REQUEST),this.next.error(e,t,s)}}class P extends j{constructor(){super(),this._watch=this._watch.bind(this)}data(){this.job_id=P.generate_job_id();const e=this.next.data(),t=e._subject_uid,s=this.options(),{subject_user:r}=s;return t&&"string"==typeof t?this.uid=t:r&&(this.uid=String(r)),Object.assign({job_id:this.job_id},e)}request(e){return this._interval=1e3,this._failures=0,this._watch_count=0,this._watch_id=setInterval(this._watch,this._interval),this.next.request(e)}success(e,t,s){return this.next.success(e,t,s)}error(e,t,s){return this.next.error(e,t,s)}complete(e,t){return this._stop(),n.Job.handled(this.job_id),this.next.complete(e,t)}_watch(){return n.Job.peek(this.job_id)?this._stop():(this._watch_count++,this._watch_count%10==0&&(clearInterval(this._watch_id),this._interval=Math.min(Math.floor(1.5*this._interval),3e4),this._watch_id=setInterval(this._watch,this._interval)),this._show_progress_modal(),this._fetch_progress())}_stop(){clearInterval(this._watch_id),n.ModalProgress.hide()}_show_progress_modal(){if(this._modal_shown)return;this._modal_shown=!0;const e=this.options();e.progress_text&&n.ModalProgress.show(e.progress_text)}_fetch_progress(){const e={};return this.uid&&(e._subject_uid=this.uid),M({url:`/job_status/${this.job_id}`,data:e,dataType:"text",success(e,t,s){let r;r=0===s.responseText.indexOf("done")?"1/1":s.responseText,n.ModalProgress.update(r)},error:(e,t,s)=>{if(this._failures++,!(this._failures<3))return this._stop(),this.next.error(e,t,s)}})}static generate_job_id(){const e=(new Date).getTime().toString();let t=Math.floor(1e6*Math.random()).toString();return t=`000000${t}`.substring(t.length),e+t}}class N extends j{data(){var e;const t=l.get_uri().getQuery().oref;return!(null===(e=this.next.data())||void 0===e?void 0:e.oref)&&t?Object.assign({oref:t},this.next.data()):this.next.data()}}const I=[class extends j{constructor(){super(),this.browser_unload_handler=this.browser_unload_handler.bind(this),this.is_browser_unloading=!1}browser_unload_handler(){this.is_browser_unloading=!0}request(e){return window.addEventListener("beforeunload",this.browser_unload_handler),this.next.request(e)}error(e,t,s){return"error"===t&&this.is_browser_unloading?this.next.error(e,"aborted","unload"):this.next.error(e,t,s)}complete(e,t){return window.removeEventListener("beforeunload",this.browser_unload_handler),this.next.complete(e,t)}}],q=[R,S,E,class extends j{error(e,t,s){if(403===e.status){const e=i.SessionStorage.get("reload-timestamp"),t=(new Date).getTime();(!e||t-e>3e4)&&(i.SessionStorage.set("reload-timestamp",t),window.location.reload())}return this.next.error(e,t,s)}}],k=[class extends j{constructor(){super(),this._clear_working_msg=this._clear_working_msg.bind(this)}request(e){let t=!1;e.catch(()=>{}).then(()=>{t=!0});const s=()=>{t||(this._should_show_working_msg()?(this._show_working_msg(),e.catch(()=>{}).then(()=>{this._clear_working_msg()})):setTimeout(s,100))};return setTimeout(s,4e3),this.next.request(e)}_should_show_working_msg(){const e=_.Notify.current();return null!=e&&Date.now()>e.shownAtMs+e.durationMs/2}_show_working_msg(){return this.notificationId=_.Notify.success(a.STILL_WORKING),this.notificationId}_clear_working_msg(){const e=_.Notify.current();if(e&&e.timeoutId===this.notificationId)return _.Notify.clear()}}],C=[class extends j{error(e,t,s){return this._notify_dev(e,t,s),this.next.error(e,t,s)}_notify_dev(e,t,s){e.getResponseHeader("X-Debug-Url")}},O,class extends j{data(){const e=this.next.data(),t={};return c.PUBLIC_MODE_OVERRIDE&&(t.public_mode_override="1"),c.COUNTRY_OVERRIDE&&(t.country_override=c.COUNTRY_OVERRIDE),Object.assign(Object.assign({},t),e)}}],L=[class extends j{constructor(){super(),this._watch=this._watch.bind(this)}data(){const e=this.next.data();this.uid=e._subject_uid?String(e._subject_uid):"";const{subject_user:t}=this.options();return!this.uid&&t&&(this.uid=String(t)),e}success(e,t,s){return this._is_async_job_response(s.responseText)?(this.job_id=s.responseText.split(":")[1],this._interval=1e3,this._failures=0,this._watch_count=0,this._watch_id=setInterval(this._watch,this._interval)):this.next.success(e,t,s)}complete(e,t){if(!this._is_async_job_response(e.responseText))return this.next.complete(e,t)}_is_async_job_response(e){if(!e||0!==e.indexOf("async_task_started:"))return!1;return e.split(":")[1].match(/^[A-Za-z0-9_\-=]*$/)}_watch(){return n.Job.peek(this.job_id)?this._stop():(this._watch_count++,this._watch_count%10==0&&(clearInterval(this._watch_id),this._interval=Math.min(Math.floor(1.5*this._interval),3e4),this._watch_id=setInterval(this._watch,this._interval)),this._show_progress_modal(),this._fetch_progress())}_stop(){clearInterval(this._watch_id),n.ModalProgress.hide()}_show_progress_modal(){if(this._modal_shown)return;this._modal_shown=!0;const{progress_text:e}=this.options();e&&n.ModalProgress.show(e)}_fetch_progress(){const e={};return this.uid&&(e._subject_uid=this.uid),U({url:`/async_task_status/${this.job_id}`,data:e,dataType:"text",success:(e,s,r)=>{let o=r.responseText;if(0===o.indexOf("done:"))return n.Job.handled(this.job_id),this._stop(),o=o.substr("done:".length),r.responseText=o,this.next.success(e,s,r),this.next.complete(r,s);if(0===o.indexOf(t.RESPONSE_PREFIX_NOTIFY_ERROR)){n.Job.handled(this.job_id),this._stop();const e=o.substr(t.RESPONSE_PREFIX_NOTIFY_ERROR.length);return _.Notify.error(e),this.next.error(r,s,e),this.next.complete(r,s)}if(0===o.indexOf("async_task_err:")){n.Job.handled(this.job_id),this._stop();const e=o.substr("async_task_err:".length),{skipNotifyError:t}=this.options();return t||_.Notify.error(new h.HTML(e)),this.next.error(r,s,e),this.next.complete(r,s)}n.ModalProgress.update(o)},error:(e,t,s)=>{if(this._failures++,!(this._failures<3))return this._stop(),this.next.error(e,t,s),this.next.complete(e,t)}})}}],A=[].concat(I,k,T,C,q,L);t.WebRequest=function(e){return null==e&&(e={}),b(e,A)},t.WebRequestOref=function(e){return null==e&&(e={}),b(e,[].concat(N,A))};const D=[].concat(I,k,class extends j{success(e,s,r){if(!this.options().skipErrorHandling){if(!r.responseText.length)return this.next.error(r,s,"AJAX Form response was empty.");if(0===r.responseText.indexOf(t.RESPONSE_PREFIX_NOTIFY_ERROR)){const e=r.responseText.substr(t.RESPONSE_PREFIX_NOTIFY_ERROR.length);return this.next.error(r,s,e)}}return this.next.success(e,s,r)}},C,q,L);t.FormWebRequest=function(e){return null==e&&(e={}),b(e,D)};const F=[].concat(I,k,T,C,q,P,L);function M(e){return null==e&&(e={}),b(e,[].concat(I,C,q))}t.WebProgressRequest=function(e){return null==e&&(e={}),b(e,F)},t.BackgroundRequest=M;const X=[R,S,E],B=[].concat(I,C,X);function U(e){return null==e&&(e={}),b(e,B)}t.SilentBackgroundRequest=U,t.ValidationSchemaRequest=function(e){return e.type="OPTIONS",b(e,q)},t.SilentBackgroundBeaconRequest=function(e){var t;null==e&&(e={});const s=null===(t=navigator.sendBeacon)||void 0===t?void 0:t.bind(navigator);if(!s)return U(e);const r=new v(e),n=w(r,[].concat(X,O)),o=n.url(),i=(e=>{const t=new FormData;for(const s of Object.keys(e)){const r=e[s];(null===r?[]:Array.isArray(r)?r:[r]).forEach(e=>{let r;void 0!==e&&(r=!0===e?"true":!1===e?"false":"number"==typeof e?String(e):e,t.append(s,r))})}return t})(n.data());s(String(o),i)||console.warn(`Beacon request failed: ${o}`)}})),define("metaserver/static/js/deprecated_ajax/job_progress",["require","exports","metaserver/static/js/clean/dbmodal_stack"],(function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Job=t.ModalProgress=void 0;const r={complete:{},handled(e){if(!e)return!1;const t=!!r.complete[e];return r.complete[e]=!0,t},peek:e=>!!e&&!!r.complete[e]};t.Job=r;const n={show(e){var t;if(!e)return;null===(t=s.DBModalStack.top())||void 0===t||t.hide();const r=document.createElement("div");r.id="modal-progress-overlay",r.style.position="fixed",r.style.width="100%",r.style.height="100%",r.style.display="none",r.classList.add("fade-out"),document.body.appendChild(r);const n=document.createElement("div");n.id="modal-progress-content",n.style.display="none",n.classList.add("fade-out");const o=document.createElement("div");o.id="modal-progress-bar";const i=(function(e,t=300){const s=t.toString()+"px",r=document.createElement("div");r.classList.add("outer-progress-bar");const n=document.createElement("div");n.style.width=s,n.id=`pb_${e}`,n.classList.add("inner-progress-bar");const o=document.createElement("div");o.style.width=s,o.classList.add("under-pb"),o.classList.add("progress-bar");const i=document.createElement("div");i.style.display="none",i.id=`pb_${e}_over`,i.classList.add("over-pb"),i.classList.add("progress-bar");const a=document.createElement("div");a.style.width=s,a.id=`pb_${e}_upct`,a.classList.add("pb-percentage");const c=document.createElement("div");return c.style.width=s,c.id=`pb_${e}_opct`,c.classList.add("pb-percentage"),o.appendChild(a),i.appendChild(c),n.appendChild(o),n.appendChild(i),r.appendChild(n),r})("modal-progress",150);o.appendChild(i);const a=document.createElement("div");a.id="modal-progress-text",a.textContent=e;const c=document.createElement("modal-progress-container");c.id="modal-progress-container",c.appendChild(o),c.appendChild(a),n.appendChild(c),document.body.appendChild(n),r.style.display="",r.classList.add("fade-to"),r.classList.remove("fade-out"),n.style.display="",n.classList.add("fade-in"),n.classList.remove("fade-out")},update(e){e.indexOf("progress")>-1&&(e=e.substring("progress".length)),(function(e,t){const s=document.querySelector(`#pb_${e}_over`);if(!s)return;const r=t.split("/").map(Number),n=r.length>1?r[0]/r[1]:r[0],o=isNaN(n)?0:n;s.style.width=`${100*Math.min(o,1)}%`,s.style.display="",s.style.backgroundColor="#348DD3",s.style.overflow="hidden"})("modal-progress",e)},hide(){const e=document.querySelector("#modal-progress-overlay");e&&(e.classList.add("fade-out"),e.classList.remove("fade-to"),window.setTimeout(()=>{e.remove()},250));const t=document.querySelector("#modal-progress-content");t&&(t.classList.add("fade-out"),t.classList.remove("fade-in"),window.setTimeout(()=>{t.remove()},250))}};t.ModalProgress=n})),define("metaserver/static/js/deprecated_ajax/util",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeQueryParams=t.jqParam=void 0;const s={};function r(e){return null===e?String(e):s[toString.call(e)]||"object"}function n(e){return(function(e){return"object"===r(e)})(e)&&!(function(e){return null!==e&&e===e.window})(e)&&Object.getPrototypeOf(e)===Object.prototype}["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"].forEach(e=>{s["[object "+e+"]"]=e.toLowerCase()});t.jqParam=function(e,t=!1){const s=[];return s.add=function(e,t){(function(e){return"function"===r(e)})(t)&&(t=t()),void 0!==t&&(null===t&&(t=""),s.push(encodeURIComponent(e)+"="+encodeURIComponent(t)))},(function e(t,s,o=!1,i=""){let a;const c=Array.isArray(s),d=n(s);Object.entries(s).forEach(([s,n])=>{a=r(n),i&&(s=o?i:i+"["+(d||"object"===a||"array"===a?s:"")+"]"),!i&&c?t.add(n.name,n.value):"array"===a||!o&&"object"===a?e(t,n,o,s):t.add(s,n)})})(s,e,t),s.join("&").replace(/%20/g,"+")},t.mergeQueryParams=function(e,s){const r=e.startsWith("//"),n=!r&&!e.includes("://")?"http://example":r?"http:":"",o=new URL(n+e),i={};o.searchParams.forEach((function(e,t){i[t]=e})),Object.keys(s).forEach(e=>{let t=s[e];null===t&&(t=""),void 0!==t&&(i[e]=t)});const a=[];Object.entries(i).forEach(([e,s])=>{a.push((0,t.jqParam)({[e]:s},!0))}),o.search=a.join("&");let c=o.toString();return c=c.slice(n.length),c}}));
//# sourceMappingURL=pkg-core-deprecated.min.js-vflYRmzWD.map